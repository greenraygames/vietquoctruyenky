<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Example</title>
    <style>
        body, html
		{
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }
        canvas 
		{
            display: block;
        }
		
		#loginTextbox, #loginButton 
		{
            position: absolute;
            z-index: 10;  /* Make sure the login elements are above the canvas */
        }

        #loginTextbox {
            top: 200px; /* Adjust position on the screen */
            left: 50%;
            transform: translateX(-50%);
            padding: 10px;
            font-size: 16px;
            width: 200px;
        }

        #loginButton {
            top: 250px; /* Adjust position under the textbox */
            left: 50%;
            transform: translateX(-50%);
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<input type="text" id="loginTextbox" placeholder="Nhập tên...">
<button id="loginButton">Vào Chơi</button>

<script> //top variables
	const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Resize canvas to full window size
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Load the background and character images
	const loginBG = new Image();
    const background = new Image();
    const character = new Image();
	const character_L = new Image();

	loginBG.src = 'login.png';
	background.src = 'background.png'; // Path to your large background image
    character.src = 'character.png'; // Path to your character image
	character_L.src = 'character left.png'; 
	
	let characterOffsetX;
	let characterOffsetY;

    // Game variables
    let cameraX = 0;
    let cameraY = 0;
	let movingLeft;
	
	 // Textbox variables
    let isTextboxFocused = false;
    let textContent = "Bấm vô đây để chat...";
    let textboxX = 10;
    let textboxY = canvas.height - 40;
    let textboxWidth = 400;
    let textboxHeight = 30;
	
	let chatHistory = []; // Array to store the chat history
	const historyMaxLines = 5; // Limit of lines in the chat history
	const historyX = 10; // X position for the chat history
    const historyY = canvas.height - 250; // Y position for the chat history
    const historyWidth = 400; // Width of the chat area
    const historyHeight = 200; // Height of the chat area
    const lineHeight = 20; // Space between lines in the chat area
	
	const serverAddress = "103.252.123.95";
	const serverPort = 2111;
	var ws;

	let mainUserName = "???";
	let connected = false;
	let loggedIn = false;
	
	const initialCanvasWidth = 1366;  // Your game's design width
	const initialCanvasHeight = 768;
	
	let scaleX = 1;
	let scaleY = 1;
</script>

<script> //object
	class PlayerBase
	{
		charName = "Vô Danh";
		x = 300;
		y = 300;
		xTo = 300;
		yTo = 300;
		isMovingLeft = false;
		speed = 5;
		
		MoveCharacter(xTo, yTo)
		{
			this.xTo = Math.floor(xTo);
			this.yTo = Math.floor(yTo);
		}
		
		UpdateCharacter()
		{
			const dx = this.xTo - this.x;
			const dy = this.yTo - this.y;
		    const distance = Math.sqrt(dx * dx + dy * dy);
			
		
			if (distance > this.speed) 
			{
				this.x += (dx / distance) * this.speed;
				this.y += (dy / distance) * this.speed;	
				this.isMovingLeft = dx < 0;			
			} 
			else 
			{
				this.x = this.xTo;
				this.y = this.yTo;
			}
		}
		
		DrawCharacter(cctx, camX, camY)
		{
			if(this.isMovingLeft == false)
				cctx.drawImage(character, this.x - characterOffsetX - camX, this.y - characterOffsetY - camY);
			else
				cctx.drawImage(character_L, this.x - characterOffsetX - camX, this.y - characterOffsetY - camY);
				
			//drawName
			const originalTextAlign = cctx.textAlign;
			cctx.font = '13px  Courier New';  // You can change the font size as needed
			cctx.fillStyle = '#ffffff'; // Text color
			cctx.textAlign = 'center'; // Center the text horizontally
		
			cctx.strokeStyle = '#000000';
			cctx.lineWidth = 3;
		
			cctx.strokeText(this.charName, this.x - camX, this.y - camY - 80);
			cctx.fillText(this.charName, this.x - camX, this.y - camY - 80);
		
			cctx.textAlign = originalTextAlign;
		}
	}
</script>

<script> //game initialized
	const mainPlayer = new PlayerBase();
	let otherPlayer = [];
</script>

<script> //GUI event
	document.getElementById('loginButton').addEventListener('click', () => 
	{
        mainUserName = document.getElementById('loginTextbox').value.trim();
        if (mainUserName !== "") 
		{
			ConnectToServer();
        }
    });
	
	canvas.addEventListener('click', (e) => 
	{
        const mouseX = e.clientX;
		const mouseY = e.clientY;
    if (mouseX >= textboxX && mouseX <= textboxX + textboxWidth && mouseY >= textboxY && mouseY <= textboxY + textboxHeight) 
    {
        isTextboxFocused = true;
    } 
    else 
    {
        isTextboxFocused = false;
    }

    // Only update target position if the textbox is not focused
    if (!isTextboxFocused) 
	{
		let trueX = Math.floor((e.clientX / scaleX) + cameraX);
		let trueY = Math.floor((e.clientY / scaleY) + cameraY);
		mainPlayer.MoveCharacter(trueX, trueY);
		SentData("move➤" + trueX + "/" + trueY);
		
		//AddLine("scale x = " + scaleX + ", y = " + scaleY);
    }
    });
	
	window.addEventListener('keydown', (e) => 
	{
        if (isTextboxFocused && e.key === 'Enter') 
		{
        // Add the text from the textbox to the chat history
        if (textContent.trim()) 
		{
			//gửi chat cho máy chủ
			SentData("chat➤" + textContent);
        }

        textContent = ''; // Clear the textbox after submission
        drawTextbox(); // Redraw the textbox
    } 
	else if (isTextboxFocused) 
	{
        // Handle typing behavior (Backspace, etc.)
        if (e.key === 'Backspace') 
		{
            textContent = textContent.slice(0, -1);
        } else if (e.key.length === 1) 
		{
            textContent += e.key;
        }
        drawTextbox(); // Redraw the textbox when typing
    }
    });
</script>

<script>
	function ConnectToServer()
	{
		ws = new WebSocket("ws://" + serverAddress + ":" + serverPort + "/connect"); //khởi tạo websocket, với thông tin ip và port ở phía trên.
		ws.onopen = function() 
		{
			AddLine("Đã kết nối đến máy chủ");
			RequestLogin();
        };
		
		ws.onmessage = function(event) 
		 {
			Decode(event.data);
		 }
		 
		 ws.onerror = function(error) 
		 {
			AddLine("Có lỗi: " + error.message);
		 }

		 ws.onclose = function() 
		 {
			AddLine("Mất kết nối đến máy chủ");
		 }
	}
	
	function RequestLogin()
	{
		SentData("login➤" + mainUserName);
	}
	
	function Decode(dataString)
	{
		try
		{
		let cut = dataString.split("➤");
	    let uid = cut[0];
		
		if(uid == "login echo")
		{
			mainUserName = cut[1];
			AddLine(mainUserName + " đã đăng nhập thành công!");
			BeginPlay();
			SentData("world data");
		}
		else if(uid == "world data")
		{
			let worldDat = cut[1].split("+");
			
			for(let i = worldDat.length - 1; i >= 0; i--)
			{
				let pDat = worldDat[i].split("/");
				
				if(pDat.length == 3)
				{
					let pName = pDat[0];
					let pX = +pDat[1];
					let pY = +pDat[2];
					
					if(pName != mainUserName) //other players
					{
						let playerFound = otherPlayer.find(PlayerBase => PlayerBase.charName == pName);
						
						if(playerFound)
						{
							playerFound.x = pX;
							playerFound.y = pY;
							playerFound.xTo = pX;
							playerFound.yTo = pY;
						}
						else
						{
							const po = new PlayerBase();
							po.charName = pName;
							po.x = pX;
							po.y = pY;
							po.xTo = pX;
							po.yTo = pY;
							otherPlayer.push(po);
						}
					}
					else
					{
						mainPlayer.x = pX;
						mainPlayer.y = pY;
						mainPlayer.xTo = pX;
						mainPlayer.yTo = pY;
					}
				}
			}
		}
		else if(uid == "other login")
		{
			let logDat = cut[1].split('/');
			let pName = logDat[0];
			let pX = +logDat[1];
			let pY = +logDat[2];
			
			if(pName != mainUserName)
			{
			let playerFound = otherPlayer.find(PlayerBase => PlayerBase.charName == pName);
						
			if(!playerFound)
			{
				const po = new PlayerBase();
				po.charName = pName;
				po.x = pX;
				po.y = pY;
				po.xTo = pX;
				po.yTo = pY;
				otherPlayer.push(po);
			}
			}
		}
		else if(uid == "move")
		{
			let moveDat = cut[1].split('/');
			let pName = moveDat[0];
			let mX = +moveDat[1];
			let mY = +moveDat[2];
			
			let playerFound = otherPlayer.find(PlayerBase => PlayerBase.charName == pName);
						
			if(playerFound)
			{
				playerFound.MoveCharacter(mX, mY);
			}
		}
		else if(uid == "chat")
		{
			let pName = cut[1];
			let chatDat = cut[2];
			AddLine(pName + ": " + chatDat);
		}
		else if(uid == "quit")
		{
			let pName = cut[1];
			let playerFound = otherPlayer.find(PlayerBase => PlayerBase.charName == pName);
			if(playerFound)
			{
				otherPlayer = otherPlayer.filter(p => p.charName !== pName); //filler out 
				AddLine(pName + " đã rời game.");
			}
		}
		else
		{
			AddLine("unknow coe = " + uid);
		}
		}
		catch(error)
		{
			alert("error:" + error.message);
		}
	}
	
	function BeginPlay()
	{
		mainPlayer.charName = mainUserName;
		loggedIn = true; // Update the login state
		document.getElementById('loginTextbox').style.display = 'none';  // Hide the textbox
		document.getElementById('loginButton').style.display = 'none';  // Hide the button
	}
	
	function SentData(dataSent)
	{
		if (ws != null && dataSent.trim() !== "") //kiểm tra coi websocket tồn tại chưa, với tin nhắn có hợp lệ ko.
		{
			ws.send(dataSent); //gửi qua máy chủ
		}
	}
	
	function AddLine(textAdd)
	{
		try
		{
		var now = new Date();
			var shortTime = now.toTimeString().slice(0, 5);
			
            chatHistory.push("[" + shortTime + "] " + textAdd); // Add the new message
			
            if (chatHistory.length > historyMaxLines) 
			{
                chatHistory.shift(); // Remove the oldest message if over the limit
            }
		}
		catch (error)
		{
			alert(error.message);
		}
	}
	
	function InitializeGame()
	{
	        // Draw the character at the new position
		characterOffsetX =  Math.floor(character.width / 2);
		characterOffsetY =  Math.floor(character.height - 10);
	}
	
	function DrawLoginScreen()
	{
		ctx.drawImage(loginBG, 0, 0);
		//draw textbox and button here
	}
	
	function drawTextbox() 
	{
		const cornerRadius = 10; // Radius of the rounded corners
    
    // Change the fill style depending on whether the textbox is focused
    ctx.fillStyle = isTextboxFocused ? 'rgba(0, 0, 0, 0.7)' : 'rgba(0, 0, 0, 0.3)';
    ctx.beginPath();
    ctx.moveTo(textboxX + cornerRadius, textboxY); // Move to the top-left corner
    ctx.arcTo(textboxX + textboxWidth, textboxY, textboxX + textboxWidth, textboxY + textboxHeight, cornerRadius); // Top-right corner
    ctx.arcTo(textboxX + textboxWidth, textboxY + textboxHeight, textboxX, textboxY + textboxHeight, cornerRadius); // Bottom-right corner
    ctx.arcTo(textboxX, textboxY + textboxHeight, textboxX, textboxY, cornerRadius); // Bottom-left corner
    ctx.arcTo(textboxX, textboxY, textboxX + textboxWidth, textboxY, cornerRadius); // Top-left corner
    ctx.closePath(); // Close the path
    ctx.fill(); // Fill the rounded textbox
    
    ctx.strokeStyle = '#000'; // Border color
    ctx.lineWidth = 1;
    ctx.stroke(); // Draw the border
    
    ctx.font = '15px Courier New'; // Font for text
    ctx.fillStyle = '#ffffff'; // Text color
    ctx.fillText(textContent, textboxX + 5, textboxY + 20); // Draw the text inside the textbox
    }

	function drawChatHistory() 
	{
    // Draw a background for the chat history
	ctx.fillStyle = 'rgba(0, 0, 0, 0.3)'; // Light grey with 50% transparency
	ctx.fillRect(historyX, historyY, historyWidth, historyHeight);
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 1;
    ctx.strokeRect(historyX, historyY, historyWidth, historyHeight);

    // Draw the chat messages inside the history area
    ctx.font = '15px Courier New';
    ctx.fillStyle = '#ffffff';
    let yOffset = historyY + 20; // Starting position for text

    // Draw each message in the history (up to the max lines)
    for (let i = 0; i < chatHistory.length; i++) {
        ctx.fillText(chatHistory[i], historyX + 5, yOffset);
        yOffset += lineHeight;
    }
	}
	
	function DrawGameplay()
	{
        // Move the camera to follow the character
        cameraX = mainPlayer.x - canvas.width / 2;
        cameraY = mainPlayer.y - canvas.height / 2;
		
        // Move the camera to follow the character, but prevent it from going beyond the background
        const maxCameraX = background.width - canvas.width;
        const maxCameraY = background.height - canvas.height;

        cameraX = Math.min(Math.max(mainPlayer.x - canvas.width / 2, 0), maxCameraX);
        cameraY = Math.min(Math.max(mainPlayer.y - canvas.height / 2, 0), maxCameraY);

		// Draw the background (scrolling effect)
        ctx.drawImage(background, -cameraX, -cameraY);

		mainPlayer.UpdateCharacter();
		mainPlayer.DrawCharacter(ctx, cameraX, cameraY);
		
		for(let i = otherPlayer.length - 1; i >=0; i--)
		{
			otherPlayer[i].UpdateCharacter();
			otherPlayer[i].DrawCharacter(ctx, cameraX, cameraY);
		}

		// Draw the textbox
        drawTextbox();
		
		 // Draw the chat history
    drawChatHistory();
	}

    function gameLoop() 
	{
        // Clear the canvas
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
		
		scaleX = canvas.width / initialCanvasWidth;
		scaleY = canvas.height / initialCanvasHeight;
		
		ctx.setTransform(scaleX, 0, 0, scaleY, 0, 0);  // Apply scaling
		
        ctx.clearRect(0, 0, canvas.width, canvas.height);

		if(loggedIn)
			DrawGameplay();
		else
			DrawLoginScreen();
	
        // Loop the game
        requestAnimationFrame(gameLoop);
    }

    // Start the game loop once images are loaded
    background.onload = function () {
        character.onload = function () {
			InitializeGame();
            gameLoop();
        };
    };
</script>

</body>
</html>
